name: Reset Database

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to reset (staging, production)'
        required: true
        type: choice
        options:
          - staging
          - production
      confirm:
        description: 'Type "RESET" to confirm database reset'
        required: true
        type: string
  # Allow manual trigger via repository_dispatch for automation
  repository_dispatch:
    types: [reset-database]

jobs:
  reset-database:
    name: Reset Database
    runs-on: ubuntu-latest
    
    # Only proceed if confirmation is provided
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.confirm == 'RESET') ||
      github.event_name == 'repository_dispatch'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: database-service/package-lock.json
      
      - name: Install dependencies
        working-directory: ./database-service
        run: npm ci
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION || 'us-east-1' }}
      
      - name: Get database credentials from AWS Secrets Manager
        id: get-db-secrets
        working-directory: ./database-service
        run: |
          # Determine which secret to use based on environment
          ENV=${{ github.event.inputs.environment || 'staging' }}
          SECRET_NAME="auction-db-${ENV}-credentials"
          
          echo "Fetching database credentials from: ${SECRET_NAME}"
          
          # Get secret from AWS Secrets Manager
          SECRET_JSON=$(aws secretsmanager get-secret-value --secret-id "${SECRET_NAME}" --query SecretString --output text)
          
          # Extract values (assuming JSON format: {"username":"...","password":"...","host":"...","port":"...","dbname":"..."})
          DB_USER=$(echo $SECRET_JSON | jq -r '.username')
          DB_PASS=$(echo $SECRET_JSON | jq -r '.password')
          DB_HOST=$(echo $SECRET_JSON | jq -r '.host')
          DB_PORT=$(echo $SECRET_JSON | jq -r '.port // "5432"')
          DB_NAME=$(echo $SECRET_JSON | jq -r '.dbname // "auction_db"')
          
          # Construct DATABASE_URL
          DATABASE_URL="postgresql://${DB_USER}:${DB_PASS}@${DB_HOST}:${DB_PORT}/${DB_NAME}"
          
          echo "DATABASE_URL=${DATABASE_URL}" >> $GITHUB_ENV
          echo "‚úÖ Database connection configured"
      
      - name: Reset database
        working-directory: ./database-service
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'weak-secret-key' }}
          NODE_ENV: production
        run: |
          echo "üîÑ Starting database reset..."
          npm run reset:db:ts
          echo "‚úÖ Database reset complete!"
      
      - name: Verify database reset
        working-directory: ./database-service
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'weak-secret-key' }}
        run: |
          echo "üîç Verifying database schema..."
          npm run build
          node -e "
          const { Pool } = require('pg');
          const pool = new Pool({ connectionString: process.env.DATABASE_URL });
          
          (async () => {
            try {
              const client = await pool.connect();
              const result = await client.query(\"
                SELECT table_name 
                FROM information_schema.tables 
                WHERE table_schema = 'public' 
                ORDER BY table_name
              \");
              
              console.log('üìä Current tables:');
              result.rows.forEach(row => {
                console.log('   ‚úì', row.table_name);
              });
              
              const expectedTables = ['users', 'auctions', 'bids', 'orders', 'schema_migrations'];
              const actualTables = result.rows.map(r => r.table_name);
              const missing = expectedTables.filter(t => !actualTables.includes(t));
              
              if (missing.length > 0) {
                console.error('‚ùå Missing tables:', missing);
                process.exit(1);
              }
              
              console.log('‚úÖ All expected tables present');
              
              client.release();
              await pool.end();
            } catch (error) {
              console.error('‚ùå Verification failed:', error.message);
              process.exit(1);
            }
          })();
          "
      
      - name: Notify completion
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Database reset completed successfully!"
          else
            echo "‚ùå Database reset failed!"
          fi
